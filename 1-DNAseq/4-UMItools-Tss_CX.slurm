#!/bin/bash
#SBATCH --job-name=4-UMItools-Tss_CX
#SBATCH --output=4-UMItools-Tss_CX.out
#SBATCH -t 3-00:00
#SBATCH --cpus-per-task=1
#SBATCH --mail-user=xxxxxx@pitt.edu
#SBATCH --mail-type=BEGIN,END,FAIL

### To correct TSS sequence based on Barcode_v2 sequence using UMI-tools
# remotely use Pitt HTC cluster

# Inputs: mock SAM files [*-mockTssCXonBar.sam] generated by <3-MkMockSam-TssOnBar.py>

# Outputs: standard output of UMI-tools, file prefix naming: library_mutant_replicate-Ds-mockTssCXonBar-sorted

module purge
module load gcc/8.2.0
module load umi-tools/1.0.0
module load samtools/1.10

cd /bgfs/ckaplan/Yunye/3-TSS_sequence_library/1-WT-DNAseq-TxGen_18179Kap/3_4-MkMockSam-TssOnBar/

# 1. Convert SAM file to BAM file using samtools
samtools view -bS AYR__Ec-Ds-mockTssCXonBar.sam > AYR__Ec-Ds-mockTssCXonBar.bam &
samtools view -bS BYR__Ec-Ds-mockTssCXonBar.sam > BYR__Ec-Ds-mockTssCXonBar.bam &
samtools view -bS ARY__Ec-Ds-mockTssCXonBar.sam > ARY__Ec-Ds-mockTssCXonBar.bam &
samtools view -bS AYR_WT_rep1-Ds-mockTssCXonBar.sam > AYR_WT_rep1-Ds-mockTssCXonBar.bam &
samtools view -bS AYR_WT_rep2-Ds-mockTssCXonBar.sam > AYR_WT_rep2-Ds-mockTssCXonBar.bam &
samtools view -bS AYR_WT_rep3-Ds-mockTssCXonBar.sam > AYR_WT_rep3-Ds-mockTssCXonBar.bam &
samtools view -bS BYR_WT_rep1-Ds-mockTssCXonBar.sam > BYR_WT_rep1-Ds-mockTssCXonBar.bam &
samtools view -bS BYR_WT_rep2-Ds-mockTssCXonBar.sam > BYR_WT_rep2-Ds-mockTssCXonBar.bam &
samtools view -bS BYR_WT_rep3-Ds-mockTssCXonBar.sam > BYR_WT_rep3-Ds-mockTssCXonBar.bam &
samtools view -bS ARY_WT_rep1-Ds-mockTssCXonBar.sam > ARY_WT_rep1-Ds-mockTssCXonBar.bam &
samtools view -bS ARY_WT_rep2-Ds-mockTssCXonBar.sam > ARY_WT_rep2-Ds-mockTssCXonBar.bam &
samtools view -bS ARY_WT_rep3-Ds-mockTssCXonBar.sam > ARY_WT_rep3-Ds-mockTssCXonBar.bam &
wait

# 2. sort BAM file
samtools sort AYR__Ec-Ds-mockTssCXonBar.bam -o AYR__Ec-Ds-mockTssCXonBar-sorted.bam &
samtools sort BYR__Ec-Ds-mockTssCXonBar.bam -o BYR__Ec-Ds-mockTssCXonBar-sorted.bam &
samtools sort ARY__Ec-Ds-mockTssCXonBar.bam -o ARY__Ec-Ds-mockTssCXonBar-sorted.bam &
samtools sort AYR_WT_rep1-Ds-mockTssCXonBar.bam -o AYR_WT_rep1-Ds-mockTssCXonBar-sorted.bam &
samtools sort AYR_WT_rep2-Ds-mockTssCXonBar.bam -o AYR_WT_rep2-Ds-mockTssCXonBar-sorted.bam &
samtools sort AYR_WT_rep3-Ds-mockTssCXonBar.bam -o AYR_WT_rep3-Ds-mockTssCXonBar-sorted.bam &
samtools sort BYR_WT_rep1-Ds-mockTssCXonBar.bam -o BYR_WT_rep1-Ds-mockTssCXonBar-sorted.bam &
samtools sort BYR_WT_rep2-Ds-mockTssCXonBar.bam -o BYR_WT_rep2-Ds-mockTssCXonBar-sorted.bam &
samtools sort BYR_WT_rep3-Ds-mockTssCXonBar.bam -o BYR_WT_rep3-Ds-mockTssCXonBar-sorted.bam &
samtools sort ARY_WT_rep1-Ds-mockTssCXonBar.bam -o ARY_WT_rep1-Ds-mockTssCXonBar-sorted.bam &
samtools sort ARY_WT_rep2-Ds-mockTssCXonBar.bam -o ARY_WT_rep2-Ds-mockTssCXonBar-sorted.bam &
samtools sort ARY_WT_rep3-Ds-mockTssCXonBar.bam -o ARY_WT_rep3-Ds-mockTssCXonBar-sorted.bam &
wait

# 3. index sorted BAM file
samtools index AYR__Ec-Ds-mockTssCXonBar-sorted.bam &
samtools index BYR__Ec-Ds-mockTssCXonBar-sorted.bam &
samtools index ARY__Ec-Ds-mockTssCXonBar-sorted.bam &
samtools index AYR_WT_rep1-Ds-mockTssCXonBar-sorted.bam &
samtools index AYR_WT_rep2-Ds-mockTssCXonBar-sorted.bam &
samtools index AYR_WT_rep3-Ds-mockTssCXonBar-sorted.bam &
samtools index BYR_WT_rep1-Ds-mockTssCXonBar-sorted.bam &
samtools index BYR_WT_rep2-Ds-mockTssCXonBar-sorted.bam &
samtools index BYR_WT_rep3-Ds-mockTssCXonBar-sorted.bam &
samtools index ARY_WT_rep1-Ds-mockTssCXonBar-sorted.bam &
samtools index ARY_WT_rep2-Ds-mockTssCXonBar-sorted.bam &
samtools index ARY_WT_rep3-Ds-mockTssCXonBar-sorted.bam &
wait

# 4. group = error correct
umi_tools group -I AYR__Ec-Ds-mockTssCXonBar-sorted.bam --group-out=AYR__Ec-Ds-mockTssCXonBar-sorted-grouped.tsv --log=AYR__Ec-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I BYR__Ec-Ds-mockTssCXonBar-sorted.bam --group-out=BYR__Ec-Ds-mockTssCXonBar-sorted-grouped.tsv --log=BYR__Ec-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I ARY__Ec-Ds-mockTssCXonBar-sorted.bam --group-out=ARY__Ec-Ds-mockTssCXonBar-sorted-grouped.tsv --log=ARY__Ec-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I AYR_WT_rep1-Ds-mockTssCXonBar-sorted.bam --group-out=AYR_WT_rep1-Ds-mockTssCXonBar-sorted-grouped.tsv --log=AYR_WT_rep1-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I AYR_WT_rep2-Ds-mockTssCXonBar-sorted.bam --group-out=AYR_WT_rep2-Ds-mockTssCXonBar-sorted-grouped.tsv --log=AYR_WT_rep2-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I AYR_WT_rep3-Ds-mockTssCXonBar-sorted.bam --group-out=AYR_WT_rep3-Ds-mockTssCXonBar-sorted-grouped.tsv --log=AYR_WT_rep3-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I BYR_WT_rep1-Ds-mockTssCXonBar-sorted.bam --group-out=BYR_WT_rep1-Ds-mockTssCXonBar-sorted-grouped.tsv --log=BYR_WT_rep1-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I BYR_WT_rep2-Ds-mockTssCXonBar-sorted.bam --group-out=BYR_WT_rep2-Ds-mockTssCXonBar-sorted-grouped.tsv --log=BYR_WT_rep2-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I BYR_WT_rep3-Ds-mockTssCXonBar-sorted.bam --group-out=BYR_WT_rep3-Ds-mockTssCXonBar-sorted-grouped.tsv --log=BYR_WT_rep3-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I ARY_WT_rep1-Ds-mockTssCXonBar-sorted.bam --group-out=ARY_WT_rep1-Ds-mockTssCXonBar-sorted-grouped.tsv --log=ARY_WT_rep1-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I ARY_WT_rep2-Ds-mockTssCXonBar-sorted.bam --group-out=ARY_WT_rep2-Ds-mockTssCXonBar-sorted-grouped.tsv --log=ARY_WT_rep2-Ds-mockTssCXonBar-sorted-group.log &
umi_tools group -I ARY_WT_rep3-Ds-mockTssCXonBar-sorted.bam --group-out=ARY_WT_rep3-Ds-mockTssCXonBar-sorted-grouped.tsv --log=ARY_WT_rep3-Ds-mockTssCXonBar-sorted-group.log &
wait

date
echo "yeah! I am finished!"